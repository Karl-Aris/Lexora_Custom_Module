<odoo>
  <template id="template_product_configuration" name="Product Configuration">
    <t t-call="website.layout">
      <div class="container my-4">

        <!-- Collection Dropdown -->
        <div class="mb-4">
          <label for="collection_select" class="form-label">Select Collection</label>
          <select id="collection_select" class="form-select" name="collection" onchange="location = this.value;">
            <option t-if="not selected_collection" selected="selected" disabled="disabled">Select collection</option>
            <t t-foreach="collections" t-as="col">
              <option t-att-value="'/store?collection=%s' % col" t-att-selected="col == selected_collection">
                <t t-esc="col"/>
              </option>
            </t>
          </select>
        </div>

        <!-- Color Badges: Only show if collection is selected -->
        <t t-if="selected_collection and colors">
          <div class="mb-4">
            <strong>Colors:</strong>
            <t t-foreach="colors" t-as="color">
              <a t-att-href="'/store?collection=%s%s' % (
                      selected_collection,
                      '&amp;color=' + color if selected_color != color else ''
                    )"
                 t-att-class="'badge rounded-pill me-2 px-3 py-2 ' + ('bg-secondary text-white' if color == selected_color else 'bg-light text-dark')"
                 style="cursor:pointer;">
                <t t-esc="color"/>
              </a>
            </t>
          </div>
        </t>

        <!-- Show rest only if collection selected -->
        <t t-if="selected_color">

          <div class="row">
            <!-- LEFT COLUMN: Configured image or cabinet fallback -->
            <div class="col-md-6">
              <t t-if="selected_sku">
                <!-- Load the cabinet product -->
                <t t-set="cabinet_product"
                  t-value="request.env['product.product'].sudo().search([('default_code', '=', selected_sku)], limit=1)" />

                <!-- Show configured product if a valid combination exists -->
                <t t-if="configured_product">
                  <img t-att-src="'data:image/png;base64,%s' % configured_product.image_1920.decode('utf-8')"
                      alt="Configured Product"
                      class="img-thumbnail"
                      style="width: 100%; height: 450px; object-fit: contain;" />
                  <div class="mt-2 text-center">
                    <strong t-esc="configured_product.name or 'Unnamed Product'" /><br />
                    <small class="text-muted" t-esc="configured_product.default_code or ''" />
                  </div>
                </t>

                <!-- If no combination, show fallback cabinet image -->
                <t t-elif="cabinet_product">
                  <img t-att-src="'data:image/png;base64,%s' % cabinet_product.image_1920.decode('utf-8')"
                      alt="Cabinet"
                      class="img-thumbnail"
                      style="width: 100%; height: 500px; object-fit: contain;" />
                  <div class="mt-2 text-center">
                    <strong t-esc="cabinet_product.name or 'Cabinet Product'" /><br />
                    <small class="text-muted" t-esc="cabinet_product.default_code or ''" />
                  </div>
                </t>

                <!-- If no image available -->
                <t t-else="">
                  <div class="border rounded bg-light text-muted d-flex align-items-center justify-content-center"
                      style="width: 100%; height: 500px;">
                    No image available
                  </div>
                </t>
              </t>

              <!-- If no SKU selected at all -->
              <t t-if="not selected_sku">
                <div class="border rounded bg-light text-muted d-flex align-items-center justify-content-center"
                    style="width: 100%; height: 500px;">
                  No cabinet selected
                </div>
              </t>
            </div>

            <!-- RIGHT COLUMN: Size cards -->
            <div class="col-md-6">

              <!-- Step 1: Size Selection -->
              <div class="d-flex align-items-center mb-3 w-100">
                <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center me-2" style="width: 25px; height: 25px; font-size: 12px;">
                  <strong>1</strong>
                </div>
                <h4 class="mb-0 flex-grow-1" data-bs-toggle="collapse" href="#sizeSelection" aria-expanded="false" aria-controls="sizeSelection">
                  Select Sizes
                </h4>
                <button class="btn btn-link text-decoration-none" type="button" style="font-size: 18px; padding: 0; margin-left: auto;" data-bs-toggle="collapse" href="#sizeSelection" aria-expanded="false" aria-controls="sizeSelection">
                  <span class="p-2" style="font-size: 24px; font-weight: bold;">+</span>
                </button>
              </div>

              <!-- Size Cards Grid (Collapsed by default) -->
              <div id="sizeSelection" class="collapse">
                <div class="row">
                  <t t-foreach="size_cards" t-as="card">
                    <div class="col-3 mb-3">
                      <a t-att-href="'/store?collection=%s%s%s%s%s%s' % (
                              selected_collection,
                              '&amp;color=' + selected_color if selected_color else '',
                              '&amp;cabinet_sku=' + card['cabinet_sku'] if selected_sku != card['cabinet_sku'] else '',
                              '&amp;counter_top_sku=' + selected_countertop if selected_countertop else '',
                              '&amp;mirror_sku=' + selected_mirror if selected_mirror else '',
                              '&amp;faucet_sku=' + selected_faucet if selected_faucet else ''
                            )"
                       class="text-decoration-none">
                        <div t-attf-class="card h-100 #{'border border-2 border-secondary' if card['cabinet_sku'] == selected_sku else ''}">
                          <t t-if="card['image']">
                            <img t-att-src="'data:image/png;base64,%s' % card['image']"
                                 class="card-img-top p-2" style="height: 100px; object-fit: cover;" alt="Product Image"/>
                          </t>
                          <t t-else="">
                            <div class="card-img-top bg-light text-center d-flex align-items-center justify-content-center p-2" style="height: 100px;">
                              <span class="text-muted">No Image</span>
                            </div>
                          </t>
                          <div class="card-body text-center">
                            <strong><t t-esc="card['size']"/></strong><br/>
                          </div>
                        </div>
                      </a>
                    </div>
                  </t>
                </div>
              </div>

              <!-- Step 2: Countertop -->
              <t t-if="selected_sku">

                <div class="d-flex align-items-center mb-3 w-100">
                  <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center me-2" style="width: 25px; height: 25px; font-size: 12px;">
                    <strong>2</strong>
                  </div>
                  <h4 class="mb-0 flex-grow-1" data-bs-toggle="collapse" href="#countertopSelection" aria-expanded="false" aria-controls="countertopSelection">
                    Add Countertop
                  </h4>
                  <button class="btn btn-link text-decoration-none" type="button" style="font-size: 18px; padding: 0; margin-left: auto;" data-bs-toggle="collapse" href="#countertopSelection" aria-expanded="false" aria-controls="countertopSelection">
                    <span class="p-2" style="font-size: 24px; font-weight: bold;">+</span>
                  </button>
                </div>

                <div id="countertopSelection" class="collapse">
                  <div class="row">
                    <t t-foreach="counter_top_cards" t-as="card">
                        <div class="col-3 mb-3">
                          <a t-att-href="'/store?collection=%s%s%s%s%s%s' % (
                                  selected_collection,
                                  '&amp;color=' + selected_color if selected_color else '',
                                  '&amp;cabinet_sku=' + selected_sku if selected_sku else '',
                                  '&amp;counter_top_sku=' + card['counter_top_sku'] if selected_countertop != card['counter_top_sku'] else '',
                                  '&amp;mirror_sku=' + selected_mirror if selected_mirror else '',
                                  '&amp;faucet_sku=' + selected_faucet if selected_faucet else ''
                                )"
                          class="text-decoration-none">
                          <div t-attf-class="card h-100 #{'border border-2 border-secondary' if card['counter_top_sku'] == selected_countertop else ''}">
                            <t t-if="card['image']">
                              <img t-att-src="'data:image/png;base64,%s' % card['image']"
                                  class="card-img-top p-2" style="height: 100px; object-fit: cover;" alt="Countertop Image"/>
                            </t>
                            <t t-else="">
                              <div class="card-img-top bg-light text-center d-flex align-items-center justify-content-center p-2" style="height: 100px;">
                                <span class="text-muted">No Image</span>
                              </div>
                            </t>
                          </div>
                        </a>
                      </div>
                    </t>
                  </div>
                </div>
              </t>

              <!-- Step 3: Mirror -->
              <t t-if="selected_sku">

                <div class="d-flex align-items-center mb-3 w-100">
                  <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center me-2" style="width: 25px; height: 25px; font-size: 12px;">
                    <strong>3</strong>
                  </div>
                  <h4 class="mb-0 flex-grow-1" data-bs-toggle="collapse" href="#mirrorSelection" aria-expanded="false" aria-controls="mirrorSelection">
                    Add Mirror
                  </h4>
                  <button class="btn btn-link text-decoration-none" type="button" style="font-size: 18px; padding: 0; margin-left: auto;" data-bs-toggle="collapse" href="#mirrorSelection" aria-expanded="false" aria-controls="mirrorSelection">
                    <span class="p-2" style="font-size: 24px; font-weight: bold;">+</span>
                  </button>
                </div>

                <div id="mirrorSelection" class="collapse">
                  <div class="row">
                      <t t-foreach="mirror_cards" t-as="card">
                        <div class="col-3 mb-3">
                          <a t-att-href="'/store?collection=%s%s%s%s%s%s' % (
                                  selected_collection,
                                  '&amp;color=' + selected_color if selected_color else '',
                                  '&amp;cabinet_sku=' + selected_sku if selected_sku else '',
                                  '&amp;counter_top_sku=' + selected_countertop if selected_countertop else '',
                                  '&amp;mirror_sku=' + card['mirror_sku'] if selected_mirror != card['mirror_sku'] else '',
                                  '&amp;faucet_sku=' + selected_faucet if selected_faucet else ''
                                )"
                          class="text-decoration-none">
                          <div t-attf-class="card h-100 #{'border border-2 border-secondary' if card['mirror_sku'] == selected_mirror else ''}">
                            <t t-if="card['image']">
                              <img t-att-src="'data:image/png;base64,%s' % card['image']"
                                  class="card-img-top p-2" style="height: 100px; object-fit: cover;" alt="Mirror Image"/>
                            </t>
                            <t t-else="">
                              <div class="card-img-top bg-light text-center d-flex align-items-center justify-content-center p-2" style="height: 100px;">
                                <span class="text-muted">No Image</span>
                              </div>
                            </t>
                          </div>
                        </a>
                      </div>
                    </t>
                  </div>
                </div>
              </t>

              <!-- Step 4: Faucet -->
              <t t-if="selected_sku">

              <div class="d-flex align-items-center mb-3 w-100">
                  <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center me-2" style="width: 25px; height: 25px; font-size: 12px;">
                    <strong>4</strong>
                  </div>
                  <h4 class="mb-0 flex-grow-1" data-bs-toggle="collapse" href="#faucetSelection" aria-expanded="false" aria-controls="faucetSelection">
                    Add Faucet
                  </h4>
                  <button class="btn btn-link text-decoration-none" type="button" style="font-size: 18px; padding: 0; margin-left: auto;" data-bs-toggle="collapse" href="#faucetSelection" aria-expanded="false" aria-controls="faucetSelection">
                    <span class="p-2" style="font-size: 24px; font-weight: bold;">+</span>
                  </button>
                </div>

                <div id="faucetSelection" class="collapse">
                  <div class="row">
                      <t t-foreach="faucet_cards" t-as="card">
                        <div class="col-3 mb-3">
                          <a t-att-href="'/store?collection=%s%s%s%s%s%s' % (
                                  selected_collection,
                                  '&amp;color=' + selected_color if selected_color else '',
                                  '&amp;cabinet_sku=' + selected_sku if selected_sku else '',
                                  '&amp;counter_top_sku=' + selected_countertop if selected_countertop else '',
                                  '&amp;mirror_sku=' + selected_mirror if selected_mirror else '',
                                  '&amp;faucet_sku=' + card['faucet_sku'] if selected_faucet != card['faucet_sku'] else ''
                                )"
                          class="text-decoration-none">
                          <div t-attf-class="card h-100 #{'border border-2 border-secondary' if card['faucet_sku'] == selected_faucet else ''}">
                            <t t-if="card['image']">
                              <img t-att-src="'data:image/png;base64,%s' % card['image']"
                                  class="card-img-top p-2" style="height: 100px; object-fit: cover;" alt="Faucet Image"/>
                            </t>
                            <t t-else="">
                              <div class="card-img-top bg-light text-center d-flex align-items-center justify-content-center p-2" style="height: 100px;">
                                <span class="text-muted">No Image</span>
                              </div>
                            </t>
                          </div>
                        </a>
                      </div>
                    </t>
                  </div>
                </div>
              </t>

            </div>
          </div>
        </t>

      </div>
    </t>
  </template>
</odoo>
